#!/bin/bash

# --- Bootstrapper ---
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$SCRIPT_DIR"

if [ -f "$ROOT_DIR/lib/core.sh" ]; then
    PAQX_ROOT="$ROOT_DIR"
    LIB_DIR="$PAQX_ROOT/lib"
    MODULES_DIR="$PAQX_ROOT/modules"
else
    PAQX_ROOT="/usr/local/paqx"
    LIB_DIR="$PAQX_ROOT/lib"
    MODULES_DIR="$PAQX_ROOT/modules"
fi

if [ ! -f "$LIB_DIR/core.sh" ]; then
    echo "Libraries not found. Bootstrapping PaqX..."
    
    [ "$(id -u)" != "0" ] && { echo "Error: Need root permissions."; exit 1; }
    
    mkdir -p "$PAQX_ROOT"

    if [ -f /etc/openwrt_release ]; then
        opkg update >/dev/null 2>&1
        opkg install curl tar ca-bundle >/dev/null 2>&1
    elif command -v apt-get >/dev/null; then
        apt-get update >/dev/null 2>&1 && apt-get install -y curl tar >/dev/null 2>&1
    elif command -v yum >/dev/null; then
        yum install -y curl tar >/dev/null 2>&1
    elif command -v dnf >/dev/null; then
        dnf install -y curl tar >/dev/null 2>&1
    fi
    
    echo "Downloading source code..."
    curl -L "https://github.com/bolandi-org/paqx/archive/refs/heads/main.tar.gz" -o /tmp/paqx.tar.gz
    
    if [ $? -ne 0 ]; then
        echo "Error: Download failed. Check network."
        exit 1
    fi
    
    echo "Extracting..."
    tar -xzf /tmp/paqx.tar.gz -C "$PAQX_ROOT" --strip-components=1
    rm -f /tmp/paqx.tar.gz
    
    if [ ! -f "$LIB_DIR/core.sh" ]; then
        echo "Error: Bootstrap failed. Libraries missing."
        exit 1
    fi
    echo "Bootstrap complete."
fi

source "$LIB_DIR/core.sh"
source "$LIB_DIR/utils.sh"
source "$MODULES_DIR/server.sh"
source "$MODULES_DIR/client.sh"
source "$MODULES_DIR/client_openwrt.sh"

# --- Helpers ---

get_installed_role() {
    if [ -f "$CONF_FILE" ]; then
        if grep -q 'role: "server"' "$CONF_FILE"; then echo "server"; return; fi
        if grep -q 'role: "client"' "$CONF_FILE"; then echo "client"; return; fi
    fi
    echo "none"
}

install_base_deps() {
    if [ "$(detect_os)" = "openwrt" ]; then
        opkg update && opkg install curl
    elif command -v apt-get >/dev/null; then
        apt-get update -y && apt-get install -y curl tar
    elif command -v yum >/dev/null; then
        yum install -y curl tar
    elif command -v dnf >/dev/null; then
        dnf install -y curl tar
    fi
}

download_binary_core() {
    local arch=$(detect_arch)
    local os_type="linux"
    
    log_info "Fetching latest binary release..."
    
    local b_owner=${BINARY_REPO_OWNER:-"hanselime"}
    local b_name=${BINARY_REPO_NAME:-"paqet"}

    local release_json=$(curl -sL "https://api.github.com/repos/$b_owner/$b_name/releases/latest")
    local tag=$(echo "$release_json" | grep -oP '"tag_name": "\K(.*)(?=")')
    
    local dl_url=""
    
    if [ -n "$tag" ]; then
        dl_url=$(echo "$release_json" | grep "browser_download_url" | grep "$os_type" | grep "$arch" | cut -d '"' -f 4 | head -n 1)
        
        if [ -z "$dl_url" ]; then
             local clean_ver="${tag#v}"
             dl_url="https://github.com/$b_owner/$b_name/releases/download/$tag/paqet-$os_type-$arch-$clean_ver.tar.gz"
        fi
    else
        log_warn "Could not fetch latest tag from API."
        dl_url="https://github.com/$b_owner/$b_name/releases/latest/download/paqet-$os_type-$arch.tar.gz"
    fi
    
    log_info "Downloading from: $dl_url"
    
    curl -L -f -H "User-Agent: paqx-manager" -o /tmp/paqet.tar.gz "$dl_url"
    
    if [ $? -ne 0 ]; then
        log_error "Download failed."
        return 1
    fi
    
    if ! gzip -t /tmp/paqet.tar.gz >/dev/null 2>&1; then
         log_error "Downloaded file is not a valid archive."
         rm -f /tmp/paqet.tar.gz
         return 1
    fi
    
    tar -xzf /tmp/paqet.tar.gz -C /tmp
    
    local bin=$(find /tmp -type f -name "paqet*" ! -name "*.tar.gz" | head -n 1)
    
    if [ -n "$bin" ] && [ -f "$bin" ]; then
        mkdir -p "$(dirname "$BINARY_PATH")"
        chmod +x "$bin"
        mv "$bin" "$BINARY_PATH"
        rm -f /tmp/paqet.tar.gz
        log_success "Core binary installed."
    else
        log_error "Binary not found in archive."
        return 1
    fi
}

update_core() {
    log_info "Updating Paqet binary..."
    download_binary_core
    if [ $? -eq 0 ]; then
        log_info "Restarting service..."
        if [ "$(detect_os)" = "openwrt" ]; then
            /etc/init.d/paqx restart
        else
            systemctl restart paqx
        fi
    fi
}

downgrade_core() {
    local b_owner=${BINARY_REPO_OWNER:-"hanselime"}
    local b_name=${BINARY_REPO_NAME:-"paqet"}
    local arch=$(detect_arch)
    
    log_info "Fetching available versions..."
    
    local releases_json=$(curl -sL "https://api.github.com/repos/$b_owner/$b_name/releases?per_page=6")
    
    # Extract tag names
    local tags=($(echo "$releases_json" | grep -oP '"tag_name": "\K[^"]+'))
    
    if [ ${#tags[@]} -eq 0 ]; then
        log_error "Could not fetch versions."
        return 1
    fi
    
    echo -e "\n${BOLD}--- Select Version ---${NC}"
    for i in "${!tags[@]}"; do
        echo "$((i+1))) ${tags[$i]}"
    done
    echo "0) Cancel"
    
    read -p "Select: " v_opt
    if [ "$v_opt" = "0" ] || [ -z "$v_opt" ]; then return; fi
    
    local idx=$((v_opt-1))
    if [ $idx -lt 0 ] || [ $idx -ge ${#tags[@]} ]; then
        log_error "Invalid selection."
        return 1
    fi
    
    local sel_tag="${tags[$idx]}"
    local clean_ver="${sel_tag#v}"
    
    # Try to find asset
    local dl_url="https://github.com/$b_owner/$b_name/releases/download/$sel_tag/paqet-linux-$arch-$clean_ver.tar.gz"
    
    log_info "Downloading $sel_tag..."
    curl -L -f -o /tmp/paqet.tar.gz "$dl_url"
    
    if [ $? -ne 0 ]; then
        log_error "Download failed for $sel_tag."
        return 1
    fi
    
    tar -xzf /tmp/paqet.tar.gz -C /tmp
    local bin=$(find /tmp -type f -name "paqet*" ! -name "*.tar.gz" | head -n 1)
    
    if [ -n "$bin" ] && [ -f "$bin" ]; then
        chmod +x "$bin"
        mv "$bin" "$BINARY_PATH"
        rm -f /tmp/paqet.tar.gz
        log_success "Downgraded to $sel_tag."
        
        if [ "$(detect_os)" = "openwrt" ]; then
            /etc/init.d/paqx restart
        else
            systemctl restart paqx
        fi
    else
        log_error "Binary not found in archive."
    fi
}

# =============================================
# SECOND RUN PANELS (after install)
# =============================================

# --- Server Panel ---
panel_server() {
    # Read config values once per loop
    local srv_port=$(grep 'addr: ":' "$CONF_FILE" 2>/dev/null | head -1 | grep -oP ':\K[0-9]+')
    local srv_key=$(grep 'key:' "$CONF_FILE" 2>/dev/null | head -1 | grep -oP '"[^"]*"' | tr -d '"')
    local srv_ip=$(get_public_ip)
    
    while true; do
        clear
        echo -e "${BLUE}╔═══════════════════════════════╗${NC}"
        echo -e "${BLUE}║       PaqX Server Panel       ║${NC}"
        echo -e "${BLUE}╚═══════════════════════════════╝${NC}"
        
        if systemctl is-active --quiet paqx; then
            echo -e "Status: ${GREEN}● Running${NC}"
        else
            echo -e "Status: ${RED}● Stopped${NC}"
        fi
        
        local is_enabled=$(systemctl is-enabled paqx 2>/dev/null)
        echo -e "Autostart: $([ "$is_enabled" = "enabled" ] && echo "${GREEN}Enabled${NC}" || echo "${RED}Disabled${NC}")"
        
        # Connection info card
        echo ""
        echo -e "${CYAN}┌─────────────────────────────────────────┐${NC}"
        echo -e "${CYAN}│${NC} ${BOLD}Address:${NC}  ${YELLOW}${srv_ip}:${srv_port}${NC}"
        echo -e "${CYAN}│${NC} ${BOLD}Key:${NC}      ${YELLOW}${srv_key}${NC}"
        echo -e "${CYAN}└─────────────────────────────────────────┘${NC}"
        echo ""
        echo " 1) Status"
        echo " 2) Log"
        echo " 3) Start/Stop"
        echo " 4) Restart"
        echo " 5) Disable/Enable"
        echo " 6) Settings"
        echo " 7) Update Core"
        echo " 8) Downgrade Core"
        echo " 9) Uninstall"
        echo " 0) Exit"
        echo ""
        read -p "Select: " opt
        
        case $opt in
            1)
                systemctl status paqx --no-pager
                read -n 1 -s -r -p "Press any key..."
                ;;
            2)
                journalctl -u paqx -n 30 --no-pager
                read -n 1 -s -r -p "Press any key..."
                ;;
            3)
                if systemctl is-active --quiet paqx; then
                    systemctl stop paqx
                    log_success "Stopped."
                else
                    systemctl start paqx
                    log_success "Started."
                fi
                sleep 1
                ;;
            4)
                systemctl restart paqx
                log_success "Restarted."
                sleep 1
                ;;
            5)
                if [ "$(systemctl is-enabled paqx 2>/dev/null)" = "enabled" ]; then
                    systemctl disable paqx
                    log_success "Autostart disabled."
                else
                    systemctl enable paqx
                    log_success "Autostart enabled."
                fi
                sleep 1
                ;;
            6)
                configure_server
                read -n 1 -s -r -p "Press any key..."
                ;;
            7)
                update_core
                read -n 1 -s -r -p "Press any key..."
                ;;
            8)
                downgrade_core
                read -n 1 -s -r -p "Press any key..."
                ;;
            9)
                remove_server
                exit 0
                ;;
            0) exit 0 ;;
        esac
    done
}

# --- Client Panel ---
panel_client() {
    local OS=$(detect_os)
    
    while true; do
        clear
        echo -e "${CYAN}╔═══════════════════════════════╗${NC}"
        echo -e "${CYAN}║     PaqX Client Panel         ║${NC}"
        echo -e "${CYAN}╚═══════════════════════════════╝${NC}"
        
        local is_running=false
        local is_enabled="disabled"
        
        if [ "$OS" = "openwrt" ]; then
            pgrep -f "$BINARY_PATH run" >/dev/null && is_running=true
            /etc/init.d/paqx enabled 2>/dev/null && is_enabled="enabled"
        else
            systemctl is-active --quiet paqx && is_running=true
            is_enabled=$(systemctl is-enabled paqx 2>/dev/null)
        fi
        
        if $is_running; then
             echo -e "Status: ${GREEN}● Running${NC}"
        else
             echo -e "Status: ${RED}● Stopped${NC}"
        fi
        echo -e "Autostart: $([ "$is_enabled" = "enabled" ] && echo "${GREEN}Enabled${NC}" || echo "${RED}Disabled${NC}")"
        echo ""
        echo " 1) Status"
        echo " 2) Log"
        echo " 3) Start/Stop"
        echo " 4) Restart"
        echo " 5) Disable/Enable"
        echo " 6) Settings"
        echo " 7) Update Core"
        echo " 8) Downgrade Core"
        echo " 9) Uninstall"
        echo " 0) Exit"
        echo ""
        read -p "Select: " opt
        
        case $opt in
            1)
                if [ "$OS" = "openwrt" ]; then
                    echo "PID: $(pgrep -f "$BINARY_PATH run" || echo 'not running')"
                else
                    systemctl status paqx --no-pager
                fi
                read -n 1 -s -r -p "Press any key..."
                ;;
            2)
                if [ "$OS" = "openwrt" ]; then
                    logread | grep paqx | tail -n 30
                else
                    journalctl -u paqx -n 30 --no-pager
                fi
                read -n 1 -s -r -p "Press any key..."
                ;;
            3)
                if $is_running; then
                    if [ "$OS" = "openwrt" ]; then /etc/init.d/paqx stop; else systemctl stop paqx; fi
                    log_success "Stopped."
                else
                    if [ "$OS" = "openwrt" ]; then /etc/init.d/paqx start; else systemctl start paqx; fi
                    log_success "Started."
                fi
                sleep 1
                ;;
            4)
                if [ "$OS" = "openwrt" ]; then /etc/init.d/paqx restart; else systemctl restart paqx; fi
                log_success "Restarted."
                sleep 1
                ;;
            5)
                if [ "$is_enabled" = "enabled" ]; then
                    if [ "$OS" = "openwrt" ]; then /etc/init.d/paqx disable; else systemctl disable paqx; fi
                    log_success "Autostart disabled."
                else
                    if [ "$OS" = "openwrt" ]; then /etc/init.d/paqx enable; else systemctl enable paqx; fi
                    log_success "Autostart enabled."
                fi
                sleep 1
                ;;
            6)
                if [ "$OS" = "openwrt" ]; then configure_client_openwrt; else configure_client_linux; fi
                read -n 1 -s -r -p "Press any key..."
                ;;
            7)
                update_core
                read -n 1 -s -r -p "Press any key..."
                ;;
            8)
                downgrade_core
                read -n 1 -s -r -p "Press any key..."
                ;;
            9)
                if [ "$OS" = "openwrt" ]; then remove_client_openwrt; else remove_client_linux; fi
                exit 0
                ;;
            0) exit 0 ;;
        esac
    done
}

# =============================================
# FIRST RUN (no config exists)
# =============================================

first_run_menu() {
    clear
    echo -e "${MAGENTA}╔═══════════════════════════════╗${NC}"
    echo -e "${MAGENTA}║     PaqX First Setup          ║${NC}"
    echo -e "${MAGENTA}╚═══════════════════════════════╝${NC}"
    echo ""
    echo " 1) Server"
    echo " 2) Client"
    echo " 0) Exit"
    echo ""
    read -p "Select: " opt
    
    case $opt in
        1)
            # Step 1: Ask port config
            server_pre_install
            
            # Step 2: Download dependencies & binary
            install_base_deps
            download_binary_core
            
            # Step 3: Generate key, write config, start service
            install_server
            
            # Show ip:port & encrypted key (already done in install_server)
            read -n 1 -s -r -p "Press any key..."
            panel_server
            ;;
        2)
            local OS=$(detect_os)
            
            # Step 1: Ask server ip:port, then auto/manual, then local forward port
            if [ "$OS" = "openwrt" ]; then
                client_pre_install_openwrt
            else
                client_pre_install_linux
            fi
            
            # Step 2: Download dependencies & binary
            install_base_deps
            download_binary_core
            
            # Step 3: Write config, start service
            if [ "$OS" = "openwrt" ]; then
                install_client_openwrt
            else
                install_client_linux
            fi
            
            # Show status and panel
            read -n 1 -s -r -p "Press any key..."
            panel_client
            ;;
        0) exit 0 ;;
    esac
}

# =============================================
# MAIN ENTRY POINT
# =============================================

ROLE=$(get_installed_role)

if [ "$ROLE" = "none" ]; then
    first_run_menu
elif [ "$ROLE" = "server" ]; then
    panel_server
elif [ "$ROLE" = "client" ]; then
    panel_client
fi
