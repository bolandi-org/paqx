#!/bin/bash

# --- Bootstrapper ---

# Ensure directories exist (if running from repo)
# In production install, these would be in /usr/local/paqx
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$SCRIPT_DIR"

# Override globals if running locally
if [ -f "$ROOT_DIR/lib/core.sh" ]; then
    PAQX_ROOT="$ROOT_DIR"
    LIB_DIR="$PAQX_ROOT/lib"
    MODULES_DIR="$PAQX_ROOT/modules"
else
    # Default install locations
    PAQX_ROOT="/usr/local/paqx"
    LIB_DIR="$PAQX_ROOT/lib"
    MODULES_DIR="$PAQX_ROOT/modules"
fi

if [ ! -f "$LIB_DIR/core.sh" ]; then
    echo "Library files not found. Bootstrapping PaqX..."
    
    # Check root for installation into /usr/local
    [ "$(id -u)" != "0" ] && { echo "Error: Need root permissions."; exit 1; }
    
    mkdir -p "$PAQX_ROOT"

    # Install dependencies (curl/tar) if missing
    if [ -f /etc/openwrt_release ]; then
        opkg update >/dev/null 2>&1
        opkg install curl tar ca-bundle >/dev/null 2>&1
    elif command -v apt-get >/dev/null; then
        apt-get update >/dev/null 2>&1 && apt-get install -y curl tar >/dev/null 2>&1
    elif command -v yum >/dev/null; then
        yum install -y curl tar >/dev/null 2>&1
    elif command -v dnf >/dev/null; then
        dnf install -y curl tar >/dev/null 2>&1
    fi
    
    echo "Downloading source code..."
    curl -L "https://github.com/bolandi-org/paqx/archive/refs/heads/main.tar.gz" -o /tmp/paqx.tar.gz
    
    if [ $? -ne 0 ]; then
        echo "Error: Download failed. Check network."
        exit 1
    fi
    
    echo "Extracting..."
    # --strip-components=1 removes the root folder (paqx-main)
    tar -xzf /tmp/paqx.tar.gz -C "$PAQX_ROOT" --strip-components=1
    rm -f /tmp/paqx.tar.gz
    
    if [ ! -f "$LIB_DIR/core.sh" ]; then
        echo "Error: Bootstrap failed. Libraries missing."
        exit 1
    fi
    echo "Bootstrap complete."
fi

source "$LIB_DIR/core.sh"
source "$LIB_DIR/utils.sh"

# --- Dependency Check ---
detect_os_type=$(detect_os)

install_base_deps() {
    if [ "$detect_os_type" = "openwrt" ]; then
        if ! command -v curl >/dev/null; then opkg update && opkg install curl; fi
    else
        # Linux
        local PM
        if command -v apt-get >/dev/null; then PM="apt-get"
        elif command -v yum >/dev/null; then PM="yum"
        elif command -v dnf >/dev/null; then PM="dnf"
        fi
        
        if [ -n "$PM" ]; then
            if ! command -v curl >/dev/null || ! command -v tar >/dev/null; then
                $PM update -y >/dev/null 2>&1
                $PM install -y curl tar >/dev/null 2>&1
            fi
        fi
    fi
}

get_latest_release() {
    local max_retries=3
    local retry_delay=2
    local release_json=""
    
    # Try fetching from GitHub API
    for i in $(seq 1 $max_retries); do
        release_json=$(curl -sL --fail "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/releases/latest")
        if [ -n "$release_json" ]; then break; fi
        sleep $retry_delay
    done
    
    local tag_name
    tag_name=$(echo "$release_json" | grep -oP '"tag_name": "\K(.*)(?=")')
    
    # Fallback to hardcoded known pattern if jq/grep fails
    if [ -z "$tag_name" ]; then tag_name="v1.0.0-alpha.16"; fi
    echo "$tag_name"
}

download_binary() {
    local arch
    arch=$(detect_arch)
    local os_type="linux"
    [ "$arch" = "unknown" ] && { log_error "Unsupported architecture."; return 1; }
    
    local max_retries=3
    local retry_delay=2
    local release_json=""
    
    # Try fetching from GitHub API
    for i in $(seq 1 $max_retries); do
        release_json=$(curl -sL --fail "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/releases/latest")
        if [ -n "$release_json" ]; then break; fi
        sleep $retry_delay
    done
    
    local version_tag
    version_tag=$(echo "$release_json" | grep -oP '"tag_name": "\K(.*)(?=")')
    
    log_info "Latest Release: $version_tag"
    
    # Find matching asset URL safely (Portable)
    local download_url
    download_url=$(echo "$release_json" | grep "browser_download_url" | grep "$os_type" | grep "$arch" | cut -d '"' -f 4 | head -n 1)
    
    # Fallback to manual construction if dynamic lookup failed
    if [ -z "$download_url" ]; then
        local clean_ver="${version_tag#v}"
        download_url="https://github.com/$REPO_OWNER/$REPO_NAME/releases/download/$version_tag/paqet-${os_type}-${arch}-${clean_ver}.tar.gz"
        log_warn "Asset lookup failed. Trying constructed URL: $download_url"
    else
        log_info "Found Asset URL: $download_url"
    fi
    
    log_info "Downloading..."
    curl -L --retry 3 --fail -H "User-Agent: paqx-manager" "$download_url" -o "/tmp/paqet.tar.gz"
    
    if [ $? -ne 0 ]; then
        log_error "Download failed. URL: $download_url"
        return 1
    fi
    
    tar -xzf "/tmp/paqet.tar.gz" -C "/tmp"
    local bin=$(find /tmp -type f -name "paqet*" | head -n 1)
    
    if [ -f "$bin" ]; then
        # Check if binary is executable format (not HTML error page)
        if file "$bin" | grep -qE 'ELF|executable'; then
            mkdir -p "$(dirname "$BINARY_PATH")"
            mv "$bin" "$BINARY_PATH"
            chmod +x "$BINARY_PATH"
            rm -f "/tmp/paqet.tar.gz"
            log_success "Binary installed ($arch)."
        else
            log_error "Downloaded file is not a valid binary. (Exec format error prevention)"
            rm -f "/tmp/paqet.tar.gz" "$bin"
            return 1
        fi
    else
        log_error "Binary not found in archive."
        return 1
    fi
}

# --- Menu ---

show_menu() {
    clear
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║            PAQX MANAGER - Universal Installer                 ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════╝${NC}"
    
    echo "1) Install - Server Mode (Linux)"
    echo "2) Install - Client Mode (Linux)"
    echo "3) Install - Client Mode (OpenWrt)"
    echo "4) Start Service"
    echo "5) Stop Service"
    echo "6) Client Settings (Update Server/Protocol)"
    echo "7) Logs"
    echo "0) Exit"
    echo ""
    read -p "Select option: " opt
    
    case $opt in
        1) 
            source "$MODULES_DIR/server.sh"
            check_root; install_base_deps; download_binary; install_server ;;
        2) 
            source "$MODULES_DIR/client.sh"
            check_root; install_base_deps; download_binary; install_client_linux ;;
        3) 
            source "$MODULES_DIR/client_openwrt.sh"
            check_root; install_base_deps; download_binary; install_client_openwrt ;;
        4) 
            if [ "$detect_os_type" = "openwrt" ]; then /etc/init.d/paqx start; else systemctl start paqx; fi
            log_success "Started." ;;
        5) 
            if [ "$detect_os_type" = "openwrt" ]; then /etc/init.d/paqx stop; else systemctl stop paqx; fi
            log_success "Stopped." ;;
        6)
            check_root
            if [ "$detect_os_type" = "openwrt" ]; then
                source "$MODULES_DIR/client_openwrt.sh"
                configure_client_openwrt
            else
                source "$MODULES_DIR/client.sh"
                configure_client_linux
            fi ;;
        7)
            if command -v journalctl >/dev/null; then journalctl -u paqx -n 50 --no-pager; else logread | grep paqx | tail -n 50; fi ;;
        0) exit 0 ;;
        *) echo "Invalid option" ;;
    esac
    read -n 1 -s -r -p "Press any key to continue..."
}

# --- Main ---
if [ "$1" = "install" ]; then
    show_menu
else
    while true; do show_menu; done
fi
