#!/bin/bash

# --- Bootstrapper ---

# Ensure directories exist (if running from repo)
# In production install, these would be in /usr/local/paqx
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$SCRIPT_DIR"

# Override globals if running locally
if [ -f "$ROOT_DIR/lib/core.sh" ]; then
    PAQX_ROOT="$ROOT_DIR"
    LIB_DIR="$PAQX_ROOT/lib"
    MODULES_DIR="$PAQX_ROOT/modules"
else
    # Default install locations
    PAQX_ROOT="/usr/local/paqx"
    LIB_DIR="$PAQX_ROOT/lib"
    MODULES_DIR="$PAQX_ROOT/modules"
fi

if [ ! -f "$LIB_DIR/core.sh" ]; then
    echo "Library files not found. Bootstrapping PaqX..."
    
    # Check root for installation into /usr/local
    [ "$(id -u)" != "0" ] && { echo "Error: Need root permissions."; exit 1; }
    
    mkdir -p "$PAQX_ROOT"

    # Install dependencies (curl/tar) if missing
    if [ -f /etc/openwrt_release ]; then
        opkg update >/dev/null 2>&1
        opkg install curl tar ca-bundle >/dev/null 2>&1
    elif command -v apt-get >/dev/null; then
        apt-get update >/dev/null 2>&1 && apt-get install -y curl tar >/dev/null 2>&1
    elif command -v yum >/dev/null; then
        yum install -y curl tar >/dev/null 2>&1
    elif command -v dnf >/dev/null; then
        dnf install -y curl tar >/dev/null 2>&1
    fi
    
    echo "Downloading source code..."
    curl -L "https://github.com/bolandi-org/paqx/archive/refs/heads/main.tar.gz" -o /tmp/paqx.tar.gz
    
    if [ $? -ne 0 ]; then
        echo "Error: Download failed. Check network."
        exit 1
    fi
    
    echo "Extracting..."
    # --strip-components=1 removes the root folder (paqx-main)
    tar -xzf /tmp/paqx.tar.gz -C "$PAQX_ROOT" --strip-components=1
    rm -f /tmp/paqx.tar.gz
    
    if [ ! -f "$LIB_DIR/core.sh" ]; then
        echo "Error: Bootstrap failed. Libraries missing."
        exit 1
    fi
    echo "Bootstrap complete."
fi

source "$LIB_DIR/core.sh"
source "$LIB_DIR/utils.sh"

# --- Dependency Check ---
detect_os_type=$(detect_os)

install_base_deps() {
    if [ "$detect_os_type" = "openwrt" ]; then
        if ! command -v curl >/dev/null; then opkg update && opkg install curl; fi
    else
        # Linux
        local PM
        if command -v apt-get >/dev/null; then PM="apt-get"
        elif command -v yum >/dev/null; then PM="yum"
        elif command -v dnf >/dev/null; then PM="dnf"
        fi
        
        if [ -n "$PM" ]; then
            if ! command -v curl >/dev/null || ! command -v tar >/dev/null; then
                $PM update -y >/dev/null 2>&1
                $PM install -y curl tar >/dev/null 2>&1
            fi
        fi
    fi
}

get_latest_release() {
    local max_retries=3
    local retry_delay=2
    local release_json=""
    
    # Try fetching from GitHub API
    for i in $(seq 1 $max_retries); do
        release_json=$(curl -sL --fail "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/releases/latest")
        if [ -n "$release_json" ]; then break; fi
        sleep $retry_delay
    done
    
    local tag_name
    tag_name=$(echo "$release_json" | grep -oP '"tag_name": "\K(.*)(?=")')
    
    # Fallback to hardcoded known pattern if jq/grep fails
    if [ -z "$tag_name" ]; then tag_name="v1.0.0-alpha.16"; fi
    echo "$tag_name"
}

download_binary() {
    local arch
    arch=$(detect_arch)
    local os_type="linux"
    [ "$arch" = "unknown" ] && { log_error "Unsupported architecture."; return 1; }
    
    local max_retries=3
    local retry_delay=2
    local release_json=""
    
    # Try fetching from GitHub API
    for i in $(seq 1 $max_retries); do
        release_json=$(curl -sL --fail "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/releases/latest")
        if [ -n "$release_json" ]; then break; fi
        sleep $retry_delay
    done
    
    local version_tag
    version_tag=$(echo "$release_json" | grep -oP '"tag_name": "\K(.*)(?=")')
    
    log_info "Latest Release: $version_tag"
    
    # Find matching asset URL safely (Portable)
    local download_url
    download_url=$(echo "$release_json" | grep "browser_download_url" | grep "$os_type" | grep "$arch" | cut -d '"' -f 4 | head -n 1)
    
    # Fallback to manual construction if dynamic lookup failed
    if [ -z "$download_url" ]; then
        local clean_ver="${version_tag#v}"
        download_url="https://github.com/$REPO_OWNER/$REPO_NAME/releases/download/$version_tag/paqet-${os_type}-${arch}-${clean_ver}.tar.gz"
        log_warn "Asset lookup failed. Trying constructed URL: $download_url"
    else
        log_info "Found Asset URL: $download_url"
    fi
    
    log_info "Downloading..."
    curl -L --retry 3 --fail -H "User-Agent: paqx-manager" "$download_url" -o "/tmp/paqet.tar.gz"
    
    if [ $? -ne 0 ]; then
        log_error "Download failed. URL: $download_url"
        return 1
    fi
    
    tar -xzf "/tmp/paqet.tar.gz" -C "/tmp"
    
    # Precise find: exclude the archive itself, find files named 'paqet' or 'paqet-linux-*'
    local bin=$(find /tmp -type f -name "paqet*" ! -name "*.tar.gz" | head -n 1)
    
    if [ -f "$bin" ]; then
        # Check if binary is executable format (not HTML error page)
        # Using simple check first, 'file' might not be available on all minimal systems?
        # Assuming we added 'file' dep earlier, but let's be robust.
        local file_type=$(file "$bin" 2>/dev/null)
        
        if echo "$file_type" | grep -qE 'ELF|executable'; then
            mkdir -p "$(dirname "$BINARY_PATH")"
            mv "$bin" "$BINARY_PATH"
            chmod +x "$BINARY_PATH"
            rm -f "/tmp/paqet.tar.gz"
            log_success "Binary installed ($arch)."
        else
            log_error "Validation fail: File '$bin' is type: '$file_type'"
            # rm -f "/tmp/paqet.tar.gz" "$bin" 
            return 1
        fi
    else
        log_error "Binary not found in extracted archive."
        return 1
    fi
    else
        log_error "Binary not found in archive."
        return 1
    fi
}

# --- Menu ---

# --- Menus ---

main_menu() {
    clear
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║            PAQX MANAGER - Universal Installer                 ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════╝${NC}"
    
    echo -e " ${GREEN}1)${NC} Server Manager (Linux)"
    echo -e " ${CYAN}2)${NC} Client Manager (Linux)"
    echo -e " ${MAGENTA}3)${NC} Client Manager (OpenWrt)"
    echo -e " ${RED}4)${NC} Uninstall PaqX"
    echo -e " ${YELLOW}0)${NC} Exit"
    echo ""
    read -p "Select option: " opt
    
    case $opt in
        1) server_menu ;;
        2) client_menu_linux ;;
        3) client_menu_openwrt ;;
        4) uninstall_menu ;;
        0) exit 0 ;;
        *) echo "Invalid option" ;;
    esac
}

service_control_menu() {
    local OS_TYPE="$1"
    
    status=$(service_is_active)
    enabled=$(service_is_enabled)
    
    echo -e "\n${BOLD}--- Service Control ---${NC}"
    echo -e "Status: $([ "$status" == "active" ] && echo "${GREEN}Running${NC}" || echo "${RED}Stopped${NC}")"
    echo -e "Boot:   $([ "$enabled" == "enabled" ] && echo "${GREEN}Enabled${NC}" || echo "${RED}Disabled${NC}")"
    echo "--------------------------"
    
    if [ "$status" == "active" ] || [ "$status" == "enabled" ]; then
        echo -e " ${YELLOW}1)${NC} Stop Service"
        echo -e " ${CYAN}2)${NC} Restart Service"
    else
        echo -e " ${GREEN}1)${NC} Start Service"
    fi
    
    if [ "$enabled" == "enabled" ]; then
        echo -e " ${RED}3)${NC} Disable Autostart"
    else
        echo -e " ${GREEN}3)${NC} Enable Autostart"
    fi
    
    echo -e " ${WHITE}4)${NC} View Status & Logs"
    echo -e " ${YELLOW}0)${NC} Back"
    
    read -p "Select: " s_opt
    case $s_opt in
        1)
            if [ "$status" == "active" ] || [ "$status" == "enabled" ]; then
               if [ "$OS_TYPE" = "openwrt" ]; then /etc/init.d/paqx stop; else systemctl stop paqx; fi
               log_success "Stopped."
            else
               if [ "$OS_TYPE" = "openwrt" ]; then /etc/init.d/paqx start; else systemctl start paqx; fi
               log_success "Started."
            fi
            ;;
        2)
            if [ "$status" == "active" ] || [ "$status" == "enabled" ]; then
                if [ "$OS_TYPE" = "openwrt" ]; then /etc/init.d/paqx restart; else systemctl restart paqx; fi
                log_success "Restarted."
            fi 
            ;;
        3)
            if [ "$enabled" == "enabled" ]; then
                if [ "$OS_TYPE" = "openwrt" ]; then /etc/init.d/paqx disable; else systemctl disable paqx; fi
                log_success "Disabled autostart."
            else
                if [ "$OS_TYPE" = "openwrt" ]; then /etc/init.d/paqx enable; else systemctl enable paqx; fi
                log_success "Enabled autostart."
            fi
            ;;
        4)
            if command -v journalctl >/dev/null; then 
                 systemctl status paqx --no-pager
                 echo "--- Recent Logs ---"
                 journalctl -u paqx -n 20 --no-pager
            else 
                 /etc/init.d/paqx status
                 echo "--- Recent Logs ---"
                 logread | grep paqx | tail -n 20
            fi
            read -n 1 -s -r -p "Press any key..."
            ;;
    esac
}

server_menu() {
    source "$MODULES_DIR/server.sh"
    while true; do
        clear
        echo -e "${BLUE}--- Server Manager ---${NC}"
        echo -e " ${GREEN}1)${NC} Install Server"
        echo -e " ${YELLOW}2)${NC} Service Control & Logs"
        echo -e " ${CYAN}3)${NC} Configuration (Port/Key)"
        echo -e " ${YELLOW}0)${NC} Back"
        
        read -p "Select: " opt
        case $opt in
            1) check_root; install_base_deps; download_binary; install_server; read -n 1 -s -r -p "Press any key..." ;;
            2) service_control_menu "linux"; read -n 1 -s -r -p "Press any key..." ;;
            3) check_root; configure_server; read -n 1 -s -r -p "Press any key..." ;;
            0) return ;;
        esac
    done
}

client_menu_linux() {
    source "$MODULES_DIR/client.sh"
    while true; do
        clear
        echo -e "${CYAN}--- Client Manager (Linux) ---${NC}"
        echo -e " ${GREEN}1)${NC} Install Client"
        echo -e " ${YELLOW}2)${NC} Service Control & Logs"
        echo -e " ${CYAN}3)${NC} Configuration (Server Info/Tuning)"
        echo -e " ${YELLOW}0)${NC} Back"
        
        read -p "Select: " opt
        case $opt in
            1) check_root; install_base_deps; download_binary; install_client_linux; read -n 1 -s -r -p "Press any key..." ;;
            2) service_control_menu "linux"; read -n 1 -s -r -p "Press any key..." ;;
            3) check_root; configure_client_linux; read -n 1 -s -r -p "Press any key..." ;;
            0) return ;;
        esac
    done
}

client_menu_openwrt() {
    source "$MODULES_DIR/client_openwrt.sh"
    while true; do
        clear
        echo -e "${MAGENTA}--- Client Manager (OpenWrt) ---${NC}"
        echo -e " ${GREEN}1)${NC} Install Client"
        echo -e " ${YELLOW}2)${NC} Service Control & Logs"
        echo -e " ${CYAN}3)${NC} Configuration (Server Info/Tuning)"
        echo -e " ${YELLOW}0)${NC} Back"
        
        read -p "Select: " opt
        case $opt in
            1) check_root; install_base_deps; download_binary; install_client_openwrt; read -n 1 -s -r -p "Press any key..." ;;
            2) service_control_menu "openwrt"; read -n 1 -s -r -p "Press any key..." ;;
            3) check_root; configure_client_openwrt; read -n 1 -s -r -p "Press any key..." ;;
            0) return ;;
        esac
    done
}

uninstall_menu() {
    clear
    echo -e "${RED}--- Uninstall ---${NC}"
    echo "1) Uninstall Server (Linux)"
    echo "2) Uninstall Client (Linux)"
    echo "3) Uninstall Client (OpenWrt)"
    echo "0) Back"
    
    read -p "Select: " opt
    case $opt in
        1) source "$MODULES_DIR/server.sh"; check_root; remove_server; read -n 1 -s -r -p "Press any key..." ;;
        2) source "$MODULES_DIR/client.sh"; check_root; remove_client_linux; read -n 1 -s -r -p "Press any key..." ;;
        3) source "$MODULES_DIR/client_openwrt.sh"; check_root; remove_client_openwrt; read -n 1 -s -r -p "Press any key..." ;;
        0) return ;;
    esac
}

# --- Main ---
if [ "$1" = "install" ]; then
    main_menu
else
    while true; do main_menu; done
fi
